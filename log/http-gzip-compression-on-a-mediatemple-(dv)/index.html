<!DOCTYPE html>
<html lang="en" class="no-js"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.5.0 -->
<title>HTTP gzip compression on a MediaTemple (dv) | sean henderson</title>
<meta name="generator" content="Jekyll v3.8.3" />
<meta property="og:title" content="HTTP gzip compression on a MediaTemple (dv)" />
<meta name="author" content="Sean Henderson" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="I’ve had this (mt) DV box for quite some time, mostly use it for staging, small WordPress gigs and running a qmail server that forwards mail elsewhere. It’s reliable, has lots of client-friendly features like Plesk, and can host a zillion websites. But it was always kinda slow, especially from the eastern hemisphere, and executing otherwise simple server admin stuff (like adding ssh keys) was always a bit perverted by the finicky complexities that come with Plesk. So, it wasn’t really my go-to for builds with serious production needs." />
<meta property="og:description" content="I’ve had this (mt) DV box for quite some time, mostly use it for staging, small WordPress gigs and running a qmail server that forwards mail elsewhere. It’s reliable, has lots of client-friendly features like Plesk, and can host a zillion websites. But it was always kinda slow, especially from the eastern hemisphere, and executing otherwise simple server admin stuff (like adding ssh keys) was always a bit perverted by the finicky complexities that come with Plesk. So, it wasn’t really my go-to for builds with serious production needs." />
<meta property="og:site_name" content="sean henderson" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2014-06-16T20:23:00-07:00" />
<script type="application/ld+json">
{"url":"/log/http-gzip-compression-on-a-mediatemple-(dv)/","author":{"@type":"Person","name":"Sean Henderson"},"description":"I’ve had this (mt) DV box for quite some time, mostly use it for staging, small WordPress gigs and running a qmail server that forwards mail elsewhere. It’s reliable, has lots of client-friendly features like Plesk, and can host a zillion websites. But it was always kinda slow, especially from the eastern hemisphere, and executing otherwise simple server admin stuff (like adding ssh keys) was always a bit perverted by the finicky complexities that come with Plesk. So, it wasn’t really my go-to for builds with serious production needs.","headline":"HTTP gzip compression on a MediaTemple (dv)","dateModified":"2014-06-16T20:23:00-07:00","datePublished":"2014-06-16T20:23:00-07:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"/log/http-gzip-compression-on-a-mediatemple-(dv)/"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<script>
    // this is reversed in app.js. transition in inline styles
    document.querySelector('html').style.opacity = 0;
  </script>
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
  <link class="theme-variant" rel="stylesheet" title="Materialized Dark" href="/assets/themes/materialized-dark.css" type="text/css">
  <link class="theme-variant" rel="alternate stylesheet" title="Materialized Light" href="/assets/themes/materialized-light.css" type="text/css">
  <link class="theme-variant" rel="alternate stylesheet" title="High Contrast" href="/assets/themes/high-contrast.css" type="text/css">
  <link class="theme-variant" rel="alternate stylesheet" title="Palm" href="/assets/themes/palm.css" type="text/css">
  <script src="/assets/js/modernizr.min.js"></script><link type="application/atom+xml" rel="alternate" href="/feed.xml" title="sean henderson" /><script>
if(!(window.doNotTrack === "1" || navigator.doNotTrack === "1" || navigator.doNotTrack === "yes" || navigator.msDoNotTrack === "1")) {
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-33069541-1', 'auto');
  ga('send', 'pageview');
}
</script>
  
<style>
/* fade in on loaded */
html.loaded {
  transition: opacity .5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
}

html.loaded {
  opacity: 1;
}

/* loading animation */
.loaded .loading-ring.page {
  display: none;
}

.loading-ring.page {
  display: block;
  width: 100px;
  height: 100px;
  position: relative;
}

.loading-ring.page {
  bottom: 0;
  left: 0;
  margin: auto;
  position: fixed;
  right: 0;
  top: 0;
}
.loading-ring.blog {
  margin: 0 auto;
  width: 54px;
}

.loading-ring div {
  box-sizing: border-box;
  display: block;
  position: absolute;
  width: 51px;
  height: 51px;
  margin: 6px;
  border: 6px solid #fff;
  border-radius: 50%;
  animation: loading-ring 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;
  border-color: #d33682 transparent transparent transparent;
}
.loading-ring div:nth-child(1) {
  animation-delay: -0.45s;
}
.loading-ring div:nth-child(2) {
  animation-delay: -0.3s;
}
.loading-ring div:nth-child(3) {
  animation-delay: -0.15s;
}

@keyframes loading-ring {
  0% {
    transform: rotate(0deg);
  }
  50% {
  }
  100% {
    transform: rotate(360deg);
  }
}

</style>
</head>
<body><header class="page-header" role="banner"><!-- Dropdown Structure -->
  <ul id="dropdown-more" class="dropdown-content">
    <li><a class="theme-timed" href="#!"><i class="fas fa-moon"></i><span>Night</span> Mode</a></li>
    <li><a class="theme-auto" data-theme="Auto" href="#!"><i class="fas fa-clock"></i>Automatic</a></li>
    <li><a class="theme-select" data-theme="High Contrast" href="#!"><i class="fas fa-adjust"></i>High Contrast</a></li>
    <li><a class="theme-select" data-theme="Palm" href="#!"><i class="fas fa-mobile-alt"></i>Palm</a></li>
    <!--<li><a href="#!">three</a></li>-->
    <!--li class="divider" tabindex="-1"></li>-->
  </ul>
  <div class="navbar-fixed">
    <nav class="nav-main">
      <div class="nav-wrapper container">
        <a href="#" data-target="nav-mobile" class="sidenav-trigger"><i class="fas fa-bars"><span class="sr-only">menu</span></i></a>
        <div class="brand-logo center">
          <a href="/">./sean</a><span class="hide-on-small-only"><a href="/log">/log</a><a href="#">/post</a></span>
        </div>
        <ul class="left hide-on-large-and-down" id="nav-large"><li><a class="page-link" href="/"><i class="fas fa-user"></i>About
  </a></li><li><a class="page-link" href="/log/"><i class="fas fa-pencil-alt"></i>log
  </a></li></ul>
        <ul class="right">
          <li>
            <a class="dropdown-trigger" href="#!" data-target="dropdown-more">
              <i class="fas fa-ellipsis-v right"><span class="sr-only">more</span></i>
            </a>
          </li>
        </ul>
      </div>
    </nav>
  </div>
  <ul class="sidenav" id="nav-mobile"><li><a class="page-link" href="/"><i class="fas fa-user"></i>About
  </a></li><li><a class="page-link" href="/log/"><i class="fas fa-pencil-alt"></i>log
  </a></li></ul></header>
<main class="page-content" aria-label="Content">
      <article class="post h-entry container anchorize" itemscope itemtype="http://schema.org/BlogPosting">
  <div class="post-main">
    <header class="post-header">
      <h1 class="post-title p-name" itemprop="name headline">HTTP gzip compression on a MediaTemple (dv)</h1>
      <p class="post-meta">
        {
        <br>
        <span class="indent">
          date: <time class="dt-published" datetime="2014-06-16T20:23:00-07:00" itemprop="datePublished">2014-06-16 20:23:00 -0700</time>,<br>
            author: "<span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">Sean Henderson</span></span>",<br>
          <span class="tags">
            tags: [
            
              <a href="/log/tag/devops/">devops</a>,
            
              <a href="/log/tag/server/">server</a>,
            
              <a href="/log/tag/web-performance/">web-performance</a>,
            
              <a href="/log/tag/hosting/">hosting</a>,
            
            ]
          </span>
        </span>
        }
      </p>
    </header>

    <div class="post-content e-content" itemprop="articleBody">
      <div class="toc-container"></div>
      <div class="post-content-inner">
        <p>I’ve had this (mt) DV box for quite some time, mostly use it for staging, small WordPress gigs and running a qmail server that forwards mail elsewhere. It’s reliable, has lots of client-friendly features like Plesk, and can host a zillion websites. But it was always kinda slow, especially from the eastern hemisphere, and executing otherwise simple server admin stuff (like adding ssh keys) was always a bit perverted by the finicky complexities that come with Plesk. So, it wasn’t really my go-to for builds with serious production needs.</p>

<p>Recently I’ve embarked on a mission: give out 100 free websites, to raise awareness about the benefits of quality web development in Nepal. The allure of having them all live in one central community, flexible enough to provide features like email and separate client hosting logins when needed, along with he infamous <a href="http://download1.parallels.com/Plesk/PP11/11.0/Doc/en-US/online/plesk-unix-cli/">Plesk Command Line Utilities</a> provided sufficient temptation to get toolin’. First stop: HTTP compression.</p>

<p>Well, two hours later, blatantly violating my 20 minute commit rule, there is fruit at the end of the tunnel. At first it seemed as simple as finding some good Apache <code class="highlighter-rouge">mod_deflate</code> rules, appending to <code class="highlighter-rouge">httpd.conf</code> and watching the PageSpeed rank soar. I followed <a href="http://kb.mediatemple.net/questions/1567/Compressing+web+pages+with+mod_deflate#dv">(mt)’s knowledge base article on compressing web pages with mod_deflate</a> to the letter, no luck - <code class="highlighter-rouge">Content-Encoding:gzip</code> was no where to be found in my response headers.</p>

<p>Here’s the QA session that ensued:</p>

<blockquote>
  <p><strong>Is <code class="highlighter-rouge">.htaccess</code> negating whatever I just did?</strong></p>
</blockquote>

<p>No, even after removing the boilerplate compression rules, still nothing.</p>

<blockquote>
  <p><strong>What about removing (mt)’s content type rules and sticking with the <code class="highlighter-rouge">.htaccess</code>?</strong></p>
</blockquote>

<p>Nada.</p>

<blockquote>
  <p><strong>I remembered to restart apache, right?</strong></p>
</blockquote>

<p>Once more for good measure… nope.</p>

<blockquote>
  <p><strong>Are there separate apache configs for the Plesk vhosts overwriting <code class="highlighter-rouge">httpd.conf</code>?</strong></p>
</blockquote>

<p>Negative.</p>

<blockquote>
  <p><strong>Google: “mediatemple dv mod_deflate not working”</strong></p>
</blockquote>

<p>Aha, <a href="https://forum.mediatemple.net/topic/6979-mod-deflate-only-working-on-files-1kb-anyone-help-locate-the-issue/#entry37335">someone in the (mt) community forums</a> mentioned “I’m willing to bet you’re running Nginx as a reverse proxy on your (dv) box.”</p>

<p>A quick peek into <code class="highlighter-rouge">/etc/nginx/nginx.conf</code> shows that not only are there ready-made gzip switches in place, they’ve been commented out.</p>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#gzip on;
#gzip_disable "MSIE [1-6]\.(?!.*SV1)";
</span></code></pre></div></div>

<p>After uncommenting and <code class="highlighter-rouge">service nginx restart</code>ing, gzip compression was working… for <em>only for</em> <code class="highlighter-rouge">index.html</code>! js, css, etc were still missing the elusive <code class="highlighter-rouge">Content-Encoding:gzip</code> header. Time to crack a second litre of whiskey.</p>

<p>My <code class="highlighter-rouge">mod_deflate</code> rules included all the correct content types. I even added redundant declarations in both <code class="highlighter-rouge">httpd.conf</code> and the indigenous <code class="highlighter-rouge">.htaccess</code>.</p>

<div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nc">AddOutputFilterByType</span> DEFLATE application/atom+xml \
                                  application/javascript \
                                  application/json \
                                  application/ld+json \
                                  application/rss+xml \
                                  application/vnd.ms-fontobject \
                                  application/x-font-ttf \
                                  application/x-web-app-manifest+json \
                                  application/xhtml+xml \
                                  application/xml \
                                  font/opentype \
                                  image/svg+xml \
                                  image/x-icon \
                                  text/css \
                                  text/html \
                                  text/plain \
                                  text/x-component \
                                  text/xml
</code></pre></div></div>

<p>So, back to Google, wherein lies a <a href="http://kickassability.com/apache-nginx-mod_deflate-gzip-compression-woes/">kick ass post</a> about the woes of compression on a Mediatemple DV, along with a more iterative solution:</p>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">gzip</span> <span class="no">on</span><span class="p">;</span>
    <span class="k">gzip_http_version</span> <span class="mi">1</span><span class="s">.1</span><span class="p">;</span>
    <span class="k">gzip_types</span> <span class="nc">text/plain</span> <span class="nc">text/html</span> <span class="nc">text/css</span> <span class="nc">text/javascript</span> <span class="nc">application/x-javascript</span> <span class="nc">text/xml</span> <span class="nc">application/xml</span> <span class="nc">application/xml</span><span class="s">+rss</span><span class="p">;</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">gzip</code> was on, but nginx also controls which file types will be compressed. Ok, so just <code class="highlighter-rouge">service nginx restart</code> right quick, pop back to dev tools, refresh… Huh? CSS is gzipped, and JS isn’t. So did I misspell <code class="highlighter-rouge">javacsritp</code> in <code class="highlighter-rouge">nginx.conf</code>? No, but as it turns out, if you check the response header of a .js file in any browser since the dark ages, the term is <code class="highlighter-rouge">Content-Type:text/javascript;</code>, not <code class="highlighter-rouge">text/javascript</code>. One more round of restart/refresh, and gzip goodness was fully functional.</p>

<p>So all those neglected sites on my DV are running pretty fast now, even despite the heinously slow internet speeds in Nepal, on par with a dial up modem that’s having a really good day.</p>

<p>If you’re thinking about hopping aboard the HTTP compression love boat, be sure to keep your packages safe from uncool browsers with <code class="highlighter-rouge">Vary: Accept-Encoding</code>. MaxCDN has a <a href="http://blog.maxcdn.com/accept-encoding-its-vary-important/">nice write up</a> on why it’s vary important.</p>

      </div>
    </div>

    <a class="u-url" href="/log/http-gzip-compression-on-a-mediatemple-(dv)/" hidden></a>
  </div>
</article>
<aside class="more-posts cta-full-width">
  
    <a class="prev" href="/log/compass-one-liner-for-animating-responsive-transitions/">
      <i class="fas fa-fast-backward"><span class="sr-only">Previous Post</span></i> 
      <span>
        Compass One-Liner For Automating ...
      </span>
    </a>
  
  
    <a class="next" href="/log/automating-tasks-with-launchd-in-osx/">
      <span>
        Automating Tasks With launchd In ... 
      </span>
      <i class="fas fa-fast-forward"><span class="sr-only">Next Post</span></i>
    </a>
  
</aside>
<aside class="comments"><div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = '/log/http-gzip-compression-on-a-mediatemple-(dv)/';
      this.page.identifier = '/log/http-gzip-compression-on-a-mediatemple-(dv)/';
    };

    (function() {
      var d = document, s = d.createElement('script');

      s.src = 'https://sean-sh.disqus.com/embed.js';

      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript></aside>

    </main><footer class="page-footer">
  <data class="u-url" href="/"></data>

  <div class="container">
    <div class="footer-contact row">
      <div class="col m6 s12">
        <div class="avatar" data-cycle="sean">
  <p>
    <a href="/assets/images/sean.jpg" title="view image">
      <img data-src="/assets/images/sean.jpg" alt="Sean Henderson">
    </a>
    Sean Henderson<br>
  </p>
</div>
      </div>
      <div class="col m5 offset-m1 s12"><ul class="social-media-list"><li>
      <a href="mailto:mail@sean.sh">
        <i class="fas fa-envelope fa-fw"><span class="sr-only">Email</span></i>
        <span class="u-email">mail@sean.sh</span>
      </a>
    </li><li><a href="https://github.com/sh78">
        <i class="fab fa-github fa-fw"><span class="sr-only">GitHub</span></i>
        <span class="username">sh78</span>
      </a><a href="https://gitlab.com/sh78">
        <i class="fab fa-gitlab fa-fw"><span class="sr-only">GitLab</span></i>
        <span class="username">sh78</span>
      </a></li><li>
      <a href="https://stackoverflow.com/users%2F2537500%2Fsh78">
        <i class="fab fa-stack-overflow fa-fw"><span class="sr-only">StackOverflow</span></i>
        
        <span class="username">sh78</span>
      </a>
    </li><li>
      <a href="https://twitter.com/seanmh78">
        <i class="fab fa-twitter fa-fw"><span class="sr-only">Twitter</span></i>
        <span class="username">seanmh78</span>
      </a>
    </li><li>
      <a href="https://www.linkedin.com/in/seanmhenderson">
        <i class="fab fa-linkedin fa-fw"><span class="sr-only">linkedin</span></i>
        <span class="username">seanmhenderson</span>
      </a>
    </li><li>
      <a href="https://www.facebook.com/seanmhenderson">
        <i class="fab fa-facebook fa-fw"><span class="sr-only">facebook</span></i>
        <span class="username">seanmhenderson</span>
      </a>
    </li><li>
      <a href="https://www.youtube.com/SeanHenderson7">
        <i class="fab fa-youtube fa-fw"><span class="sr-only">youtube</span></i>
        <span class="username">SeanHenderson7</span>
      </a>
    </li><li>
      <a href="/feed.xml">
        <i class="fas fa-rss fa-fw"><span class="sr-only">rss</span></i>
        <span>rss</span>
      </a>
    </li></ul>
</div>
    </div>
    <div class="foooter-copyright row">
      <div class="col s12">
        <p class="left">&copy; <code>nil</code></p>
        <p class="right">Made In California with <i class="fab fa-linux"><span class="sr-only">Linux</span></i> &amp; <i class="fas fa-beer"><span class="sr-only">beer</span></i></p>
      </div>
    </div>
  </div>

</footer>
<div class="loading-ring page">
  <div></div>
  <div></div>
  <div></div>
  <div></div>
</div>
<script>
      var allPosts = ["/log/when-an-alias-should-actually-be-an-abbr/","/log/a-testament-to-my-2010-macbook-pro/","/log/finally-a-vim-global-find-replace-that-doesn-t-hurt/","/log/switching-from-macos-high-sierra-to-fedora-linux/","/log/the-free-mega-weight-dropbox-alternative/","/log/automating-tasks-with-launchd-in-osx/","/log/http-gzip-compression-on-a-mediatemple-(dv)/","/log/compass-one-liner-for-animating-responsive-transitions/","/log/iphone-5-home-screen/","/log/paper-the-desktop-text-edit-you've-been-missing/","/log/Plesk-CLI/","/log/the-little-things-about-macs/"];
    </script>
    <script src="/assets/js/libs.js"></script>
    <script src="/assets/js/app.es5.js"></script>

  </body>

</html>
